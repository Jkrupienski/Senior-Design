<!--  dashboard.html displays desired video feed, supposed to show live graph too but is not currently -->
{% extends "base.html" %}  <!-- extend base template -->

{% block title %}Dashboard{% endblock %}  <!-- title -->

{% block content %}
<div class="main-container" style="display: flex; flex-wrap: wrap;">  <!-- main container for layout -->
    <div style="flex: 2;"> <!-- use flex for better responsiveness -->
        <h1>Employee Dashboard</h1>  <!-- page header -->
        {% if current_user.is_authenticated %}  <!-- ensure user logged in -->
        <form id="search-form" class="form-container">  <!-- container for search box -->
            <div class="form-group">
                <label for="camera_id">Camera ID</label>  <!-- label for cam search box -->
                <select id="camera_id" name="camera_id" required>  <!-- camera dropdown box, required field for search -->
                    {% for camera in cameras %}  <!-- loop thru cam list -->
                    <option value="{{ camera }}">{{ camera }}</option>  <!-- give an option for each available cam -->
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <button type="submit">Select Camera</button>  <!-- select camera submit button -->
                <button type="button" id="clear-search">Clear</button>  <!-- button to clear form (turn into stop/pause) -->
            </div>
        </form>
        <h2 id="camera-title"></h2>  <!-- header for the selected video feed cam name -->
        <div class="video-container">
            <img id="video-feed" src="{{ url_for('video_feed', camera_id='CAM01_HW_I90') }}">  <!-- default cam in vid container -->
        </div>
        {% else %}  <!-- if user not logged in -->
        <a href="{{ url_for('login') }}">Login</a>  <!-- login link if user is not yet authenticated -->
        {% endif %}
    </div>
    <div style="flex: 1; padding-left: 20px;"> <!-- padding to separate from graph -->
        <h2>Average Lane Speeds</h2>  <!-- header for average lane speeds -->
        <div id="average-speeds">
            <p>Lane One: <span id="lane-one-speed">0</span> mph</p>  <!-- display lane one speed -->
            <p>Lane Two: <span id="lane-two-speed">0</span> mph</p>  <!-- display lane two speed -->
            <p>Lane Three: <span id="lane-three-speed">0</span> mph</p>  <!-- display lane three speed -->
        </div>
    </div>
</div>
<div class="chart-container" style="margin-top: 20px;">  <!-- container for traffic chart -->
    <canvas id="trafficChart"></canvas>  <!-- GO IN FOR TRAFFIC CHART ON DASHBOARD NOW -->
</div>
{% endblock %}

{% block scripts %}  <!-- go to dashboard.js for js code -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Include Chart.js library -->
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener for the camera selection form
    document.getElementById('search-form').addEventListener('submit', function(event) {
        event.preventDefault();
        var cameraId = document.getElementById('camera_id').value;
        document.getElementById('video-feed').src = "{{ url_for('video_feed') }}?camera_id=" + cameraId;
        document.getElementById('camera-title').innerText = "Current Camera: " + cameraId;
        updateAverageSpeeds(cameraId);
    });

    // Clear search form
    document.getElementById('clear-search').addEventListener('click', function() {
        document.getElementById('search-form').reset();
        document.getElementById('video-feed').src = "{{ url_for('video_feed', camera_id='CAM01_HW_I90') }}";
        document.getElementById('camera-title').innerText = "";
        updateAverageSpeeds('CAM01_HW_I90');
    });

    // Function to fetch and display average speeds
    function updateAverageSpeeds(cameraId) {
        fetch('/avg_speeds?camera_id=' + cameraId)
            .then(response => response.json())
            .then(data => {
                document.getElementById('lane-one-speed').innerText = data.lane_one.toFixed(2);
                document.getElementById('lane-two-speed').innerText = data.lane_two.toFixed(2);
                document.getElementById('lane-three-speed').innerText = data.lane_three.toFixed(2);
            })
            .catch(error => console.error('Error fetching average speeds:', error));
    }

    // Update average speeds periodically (e.g., every minute)
    setInterval(function() {
        var cameraId = document.getElementById('camera_id').value || 'CAM01_HW_I90';
        updateAverageSpeeds(cameraId);
    }, 60000);
    updateAverageSpeeds('camera_id'); // Initial call to update speeds
});
</script>
{% endblock %}